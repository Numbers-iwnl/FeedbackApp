<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    {% now "Y-m" as current_ym %}
    <style>
        * {
            box-sizing: border-box
        }

        body {
            margin: 0 auto;
            padding: 16px;
            max-width: 1200px;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif;
        }

        a {
            color: #14b8a6;
            text-decoration: none
        }

            a:hover {
                text-decoration: underline
            }

        .muted {
            color: var(--muted)
        }

        .grow {
            flex: 1
        }

        /* Layout */
        .topbar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--primary);
            color: #031322;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none
        }

        .btn--ghost {
            background: color-mix(in srgb, var(--card) 70%, var(--bg));
            color: color-mix(in srgb, var(--text) 85%, var(--muted));
            border: 1px solid var(--line)
        }

        .btn--bare {
            background: transparent;
            border: 1px solid var(--line);
            color: color-mix(in srgb, var(--text) 85%, var(--muted));
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 14px;
            margin: 12px 0
        }

        @media (max-width:980px) {
            .cards {
                grid-template-columns: repeat(2,1fr)
            }
        }

        @media (max-width:560px) {
            .cards {
                grid-template-columns: 1fr
            }
        }

        .grid {
            display: grid;
            gap: 14px;
            grid-template-columns: 1fr 1fr
        }

        @media (max-width:980px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        /* Card shell (high contrast) */
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 1px 0 color-mix(in srgb, var(--text) 4%, transparent), 0 10px 24px color-mix(in srgb, var(--text) 10%, transparent);
        }

            .card h3 {
                margin: 0 0 8px
            }

        .kpi {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .kpi .val {
                font-size: 28px;
                font-weight: 900;
                letter-spacing: .3px
            }

            .kpi .trend {
                font-size: 12px
            }

        /* Bars */
        .bar {
            height: 10px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--card) 70%, var(--bg));
            border: 1px solid var(--line);
            overflow: hidden
        }

            .bar > i {
                display: block;
                height: 100%
            }

        .row-just {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between
        }

        /* Chips / colors */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--chip);
            color: var(--chip-txt);
            font-size: 12px;
            font-weight: 800;
            letter-spacing: .2px
        }

        .chip--pill {
            background: var(--bg);
            border: 1px solid var(--line);
            color: color-mix(in srgb, var(--text) 90%, var(--muted))
        }

        .chip--ok {
            background: color-mix(in srgb, #16a34a 30%, var(--chip));
        }

        .chip--warn {
            background: color-mix(in srgb, #f59e0b 30%, var(--chip));
            color: #111827
        }

        .chip--info {
            background: color-mix(in srgb, #3b82f6 30%, var(--chip));
        }

        /* Category color helpers (same palette site-wide) */
        .c-elogio {
            background: #10b981
        }

        .c-reclamacao {
            background: #ef4444
        }

        .c-sugestao {
            background: #6366f1
        }

        .c-status-resolvido {
            background: #16a34a
        }

        .c-status-analise {
            background: #3b82f6
        }

        .c-status-pendente {
            background: #f59e0b
        }

        .c-financeiro {
            background: #06b6d4
        }

        .c-atendimento {
            background: #f97316
        }

        .c-plataforma {
            background: #8b5cf6
        }

        .c-conteudo {
            background: #22c55e
        }

        .c-eventos {
            background: #ef4444
        }

        .c-outros {
            background: #64748b
        }

        .list {
            display: grid;
            gap: 10px
        }

        .item {
            display: grid;
            grid-template-columns: 160px 1fr auto;
            gap: 8px;
            align-items: center
        }

        @media (max-width:560px) {
            .item {
                grid-template-columns: 1fr
            }

                .item .muted {
                    text-align: left
                }
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

            .legend .dot {
                width: 10px;
                height: 10px;
                border-radius: 999px;
                display: inline-block;
                margin-right: 6px;
                border: 1px solid #0002
            }

        .mini {
            font-size: 12px
        }

        .right {
            margin-left: auto
        }

        .center {
            display: flex;
            align-items: center;
            gap: 8px
        }

        input[type="month"] {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 8px 10px
        }
    </style>
</head>
<body>

    {% include 'core/_header.html' %}

    <!-- Top controls -->
    <div class="topbar card" style="justify-content:space-between">
        <div class="row">
            <h2 style="margin:0">Dashboard</h2>
            <span class="chip chip--pill">Mês: <b id="m-label"></b></span>
        </div>
        <div class="row">
            <button class="btn--bare" id="m-prev" title="Mês anterior">◀</button>
            <input id="m-input" type="month" value="{{ current_ym }}">
            <button class="btn--bare" id="m-next" title="Próximo mês">▶</button>
        </div>
    </div>

    <!-- KPI cards -->
    <section class="cards">
        <div class="card kpi">
            <h3>Total no mês</h3>
            <div class="val" id="k-total">—</div>
            <div class="trend mini muted" id="k-total-trend">—</div>
            <div class="legend mini">
                <span><span class="dot c-elogio"></span>Elogios</span>
                <span><span class="dot c-reclamacao"></span>Reclamações</span>
                <span><span class="dot c-sugestao"></span>Sugestões</span>
            </div>
        </div>

        <div class="card kpi">
            <h3>Taxa de resolução</h3>
            <div class="val" id="k-res">—</div>
            <div class="bar"><i id="bar-res" style="width:0%;background:#16a34a"></i></div>
            <div class="mini muted">Resolvidos / Total</div>
        </div>

        <div class="card kpi">
            <h3>Elogios × Reclamações</h3>
            <div class="row-just">
                <span class="chip chip--ok" id="k-elogios">Elogios: —</span>
                <span class="chip" style="background:#ef4444;color:#fee2e2" id="k-reclamacoes">Reclamações: —</span>
            </div>
            <div class="bar"><i id="bar-elogio" style="width:0%" class="c-elogio"></i></div>
            <div class="bar" style="margin-top:8px"><i id="bar-recl" style="width:0%" class="c-reclamacao"></i></div>
        </div>

        <div class="card kpi">
            <h3>Sugestões</h3>
            <div class="val" id="k-sugestoes">—</div>
            <div class="bar"><i id="bar-sug" style="width:0%" class="c-sugestao"></i></div>
            <div class="mini muted right"><a id="lnk-sug" href="#">ver lista ›</a></div>
        </div>
    </section>

    <!-- Two columns -->
    <section class="grid">
        <!-- Tipos & Status -->
        <div class="card">
            <h3 style="margin-bottom:6px">Tipos no mês</h3>
            <div class="list" id="list-type">
                <!-- rows injected -->
            </div>

            <div class="row" style="margin-top:12px">
                <h3 class="grow" style="margin:0">Status</h3>
                <div class="legend mini">
                    <span><span class="dot c-status-pendente"></span>Pendente</span>
                    <span><span class="dot c-status-analise"></span>Em análise</span>
                    <span><span class="dot c-status-resolvido"></span>Resolvido</span>
                </div>
            </div>
            <div class="list" id="list-status" style="margin-top:6px">
                <!-- rows injected -->
            </div>
        </div>

        <!-- Assuntos & Top cursos -->
        <div class="card">
            <div class="row" style="justify-content:space-between">
                <h3 style="margin:0">Assuntos (distribuição)</h3>
                <div class="legend mini">
                    <span><span class="dot c-financeiro"></span>Financeiro</span>
                    <span><span class="dot c-atendimento"></span>Atendimento</span>
                    <span><span class="dot c-plataforma"></span>Plataforma</span>
                    <span><span class="dot c-conteudo"></span>Conteúdo</span>
                    <span><span class="dot c-eventos"></span>Eventos</span>
                    <span><span class="dot c-outros"></span>Outros</span>
                </div>
            </div>

            <div class="list" id="list-subject" style="margin-top:6px">
                <!-- rows injected -->
            </div>

            <div class="row" style="margin-top:14px">
                <h3 style="margin:0">Top cursos/turmas</h3>
                <span class="mini muted">(top 5 no mês)</span>
            </div>
            <div class="list" id="list-course">
                <!-- rows injected -->
            </div>
        </div>
    </section>

    <script>
(function(){
  const ymInput = document.getElementById('m-input');
  const ymPrev  = document.getElementById('m-prev');
  const ymNext  = document.getElementById('m-next');
  const mLabel  = document.getElementById('m-label');

  const months = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);

  // quick helpers
  const qs = sel => document.querySelector(sel);
  const el = id => document.getElementById(id);

  function parseYM(ym){
    const [y,m] = ym.split('-').map(x=>parseInt(x,10));
    return {y, m}; // m 1..12
  }
  function fmtMonthLabel(ym){
    const {y,m} = parseYM(ym);
    return cap(months[m-1]) + '/' + y;
  }
  function ymAdd(ym, delta){
    let {y,m} = parseYM(ym);
    m += delta;
    while (m < 1){ m += 12; y -= 1; }
    while (m > 12){ m -= 12; y += 1; }
    return y.toString().padStart(4,'0') + '-' + m.toString().padStart(2,'0');
  }
  function monthRange(ym){
    const {y,m} = parseYM(ym);
    const last = new Date(y, m, 0).getDate(); // JS month is 1..12 here because we gave m, Date expects 0..11 in ctor trick
    const de  = `${y}-${String(m).padStart(2,'0')}-01`;
    const ate = `${y}-${String(m).padStart(2,'0')}-${String(last).padStart(2,'0')}`;
    return {de, ate};
  }

  // color maps (consistent with site)
  const colorType = {
    elogio: '#10b981',
    reclamacao: '#ef4444',
    sugestao: '#6366f1',
  };
  const colorStatus = {
    pendente: '#f59e0b',
    em_analise: '#3b82f6',
    resolvido: '#16a34a',
  };
  const colorSubject = {
    financeiro:'#06b6d4', atendimento:'#f97316', plataforma:'#8b5cf6',
    conteudo:'#22c55e', eventos:'#ef4444', outros:'#64748b'
  };

  // DOM injectors
  function row(container, label, value, pct, color, listLinkHref){
    const wrap = document.createElement('div');
    wrap.className = 'item';
    const a = document.createElement('div'); a.textContent = label;
    const bar = document.createElement('div'); bar.className='bar';
    const i = document.createElement('i'); i.style.width = (pct||0) + '%'; i.style.background = color;
    bar.appendChild(i);
    const right = document.createElement('div'); right.className='mini muted';
    right.innerHTML = (value ?? 0) + ' · ' + (isFinite(pct) ? pct.toFixed(0) : 0) + '%';
    wrap.appendChild(a); wrap.appendChild(bar); wrap.appendChild(right);
    if (listLinkHref){
      const link = document.createElement('a'); link.href=listLinkHref; link.className='mini'; link.textContent='ver ›';
      link.style.marginLeft='8px';
      right.appendChild(link);
    }
    container.appendChild(wrap);
  }

  // fetch helpers
  async function getJSON(url){
    const r = await fetch(url, {credentials:'same-origin'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  // main render
  async function render(ym){
    mLabel.textContent = fmtMonthLabel(ym);

    // current + previous for trend
    const prevYM = ymAdd(ym, -1);

    const [sum, sumPrev, brk] = await Promise.all([
      getJSON(`/stats/summary/?month=${ym}`),
      getJSON(`/stats/summary/?month=${prevYM}`),
      getJSON(`/stats/breakdown/?month=${ym}`),
    ]);

    // KPIs
    const total = sum.total || 0;
    el('k-total').textContent = total;
    const diff = total - (sumPrev.total || 0);
    const sign = diff === 0 ? '' : (diff > 0 ? '▲ +' : '▼ ');
    el('k-total-trend').textContent =
      (sumPrev.total ? `${sign}${Math.abs(diff)} vs ${fmtMonthLabel(prevYM)}` : '—');

    const resPct = total ? Math.round(100*sum.resolvidos/total) : 0;
    el('k-res').textContent = resPct + '%';
    el('bar-res').style.width = resPct + '%';

    const pElo = total ? Math.round(100*sum.elogios/total) : 0;
    const pRec = total ? Math.round(100*sum.reclamacoes/total) : 0;
    el('k-elogios').textContent = `Elogios: ${sum.elogios||0}`;
    el('k-reclamacoes').textContent = `Reclamações: ${sum.reclamacoes||0}`;
    el('k-sugestoes').textContent = sum.sugestoes || 0;
    el('bar-elogio').style.width = pElo + '%';
    el('bar-recl').style.width   = pRec + '%';
    el('bar-sug').style.width    = (total? Math.round(100*sum.sugestoes/total):0) + '%';

    // quick links (month range)
    const {de, ate} = monthRange(ym);
    const enc = (s)=> encodeURIComponent(s);

    // detail lists
    const listType   = el('list-type');   listType.innerHTML = '';
    const listStatus = el('list-status'); listStatus.innerHTML = '';
    const listSubject= el('list-subject');listSubject.innerHTML = '';
    const listCourse = el('list-course'); listCourse.innerHTML = '';

    const types = brk.type || [];
    types.forEach(t=>{
      const key = Object.keys(colorType).includes(t.label.toLowerCase()) ? t.label.toLowerCase() : null;
      const pct = total ? (100*(t.value||0)/total) : 0;
      const link = `/feedbacks/?tipo=${enc(key||'')}&de=${de}&ate=${ate}`;
      const color = colorType[key] || '#8ea0b6';
      row(listType, t.label, t.value, pct, color, link);
    });

    const statuses = brk.status || [];
    statuses.forEach(s=>{
      const key = s.label.toLowerCase().replace(' ', '_');
      const pct = total ? (100*(s.value||0)/total) : 0;
      const link = `/feedbacks/?status=${enc(key)}&de=${de}&ate=${ate}`;
      const color = colorStatus[key] || '#8ea0b6';
      row(listStatus, s.label, s.value, pct, color, link);
    });

    const subjects = brk.subject || [];
    subjects.forEach(s=>{
      const key = s.label.toLowerCase();
      const pct = total ? (100*(s.value||0)/total) : 0;
      const link = `/feedbacks/?assunto=${enc(key)}&de=${de}&ate=${ate}`;
      const color = colorSubject[key] || '#8ea0b6';
      row(listSubject, s.label, s.value, pct, color, link);
    });

    // top courses (sort desc and take 5)
    const courses = (brk.course || []).slice().sort((a,b)=> (b.value||0)-(a.value||0)).slice(0,5);
    courses.forEach(c=>{
      const label = c.label || '—';
      const pct = total ? (100*(c.value||0)/total) : 0;
      const link = `/feedbacks/?curso=${enc(label)}&de=${de}&ate=${ate}`;
      row(listCourse, label, c.value, pct, '#14b8a6', link);
    });

    // quick sug link
    el('lnk-sug').href = `/feedbacks/?tipo=sugestao&de=${de}&ate=${ate}`;
  }

  // init
  function boot(){
    const ym = ymInput.value || '{{ current_ym }}';
    mLabel.textContent = fmtMonthLabel(ym);
    render(ym).catch(()=>{ /* ignore for now */ });
  }

  ymPrev.addEventListener('click', ()=>{
    ymInput.value = ymAdd(ymInput.value, -1);
    mLabel.textContent = fmtMonthLabel(ymInput.value);
    render(ymInput.value);
  });
  ymNext.addEventListener('click', ()=>{
    ymInput.value = ymAdd(ymInput.value, 1);
    mLabel.textContent = fmtMonthLabel(ymInput.value);
    render(ymInput.value);
  });
  ymInput.addEventListener('change', ()=> render(ymInput.value));

  boot();
})();
    </script>

</body>
</html>
