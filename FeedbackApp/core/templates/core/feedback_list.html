<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <title>Feedbacks</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        /* Uses the theme tokens defined in _header.html (dark default, light supported) */
        * {
            box-sizing: border-box
        }

        body {
            margin: 0 auto;
            padding: 16px;
            max-width: 1200px;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif;
        }

        a {
            color: var(--primary);
            text-decoration: none
        }

            a:hover {
                text-decoration: underline
            }

        .muted {
            color: var(--muted)
        }

        .grow {
            flex: 1
        }

        /* ===== Filters ===== */
        .filters {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(12,1fr);
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
            margin: 10px 0 18px;
            box-shadow: 0 8px 20px color-mix(in srgb, var(--text) 8%, transparent);
        }

            .filters input, .filters select {
                width: 100%;
                background: var(--bg);
                color: var(--text);
                border: 1px solid var(--line);
                border-radius: 10px;
                padding: 10px;
            }

            .filters .w-3 {
                grid-column: span 3
            }

            .filters .w-2 {
                grid-column: span 2
            }

            .filters .w-4 {
                grid-column: span 4
            }

            /* left aligned buttons */
            .filters .right {
                display: flex;
                gap: 8px;
                justify-content: flex-start;
                align-items: center;
            }

        /* base buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--primary);
            color: #031322;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none;
        }

        .btn--ghost {
            background: color-mix(in srgb, var(--card) 70%, var(--bg));
            color: color-mix(in srgb, var(--text) 85%, var(--muted));
            border: 1px solid var(--line);
        }

        .btn--sm {
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700
        }

        /* hero buttons (filters only) */
        .btn-hero {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0b5f3c;
            color: #eafff7;
            border: 1px solid color-mix(in srgb, #0b5f3c 70%, #000);
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 800;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 6px 14px color-mix(in srgb, #0b5f3c 35%, transparent), 0 1px 0 color-mix(in srgb, #000 15%, transparent) inset;
            transform: translateY(0);
            transition: transform .12s, box-shadow .12s, background .12s;
        }

            .btn-hero:hover {
                background: #0d6f48;
                box-shadow: 0 8px 18px color-mix(in srgb, #0d6f48 45%, transparent), 0 1px 0 color-mix(in srgb, #000 18%, transparent) inset;
                transform: translateY(-1px);
            }

            .btn-hero:active {
                background: #0a5738;
                transform: translateY(0)
            }

        .btn-hero--ghost {
            background: color-mix(in srgb, var(--card) 70%, var(--bg));
            color: color-mix(in srgb, var(--text) 85%, var(--muted));
            border: 1px solid var(--line);
            box-shadow: none;
        }

            .btn-hero--ghost:hover {
                background: color-mix(in srgb, var(--card) 60%, var(--bg))
            }

        /* ===== Card grid ===== */
        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill,minmax(360px,1fr));
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 1px 0 color-mix(in srgb, var(--text) 4%, transparent), 0 10px 24px color-mix(in srgb, var(--text) 10%, transparent);
            min-height: 192px;
        }

        .card--dim {
            opacity: .65;
            filter: saturate(.9)
        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap
        }

        .sep {
            height: 1px;
            background: var(--line);
            border-radius: 1px
        }

        /* chips/badges */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--bg);
            border: 1px solid var(--line);
            color: color-mix(in srgb, var(--text) 90%, var(--muted));
            font-size: 12px;
            font-weight: 800;
            letter-spacing: .2px;
        }

            .chip .material-symbols-rounded {
                font-size: 18px
            }

        .chip--id {
            background: color-mix(in srgb, var(--card) 70%, var(--bg))
        }

        .chip--count {
            padding: 2px 8px
        }

        .status {
            margin-left: auto;
            font-weight: 800;
            letter-spacing: .2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: var(--bg);
        }

        .status--pendente {
            background: color-mix(in srgb, #f59e0b 22%, var(--bg));
            color: #111827
        }

        .status--em_analise {
            background: color-mix(in srgb, #3b82f6 18%, var(--bg))
        }

        .status--resolvido {
            background: color-mix(in srgb, #16a34a 18%, var(--bg))
        }

        /* tags with colored dot */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: var(--bg);
            font-size: 12px;
            font-weight: 800;
            color: color-mix(in srgb, var(--text) 92%, var(--muted));
        }

            .tag i {
                width: 8px;
                height: 8px;
                border-radius: 999px;
                display: inline-block;
                border: 1px solid #0002
            }

        .t-elogio i {
            background: #10b981
        }

        .t-reclamacao i {
            background: #ef4444
        }

        .t-sugestao i {
            background: #6366f1
        }

        .s-financeiro i {
            background: #06b6d4
        }

        .s-atendimento i {
            background: #f97316
        }

        .s-plataforma i {
            background: #8b5cf6
        }

        .s-conteudo i {
            background: #22c55e
        }

        .s-eventos i {
            background: #ef4444
        }

        .s-outros i {
            background: #64748b
        }

        /* footer actions */
        .card__footer {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: auto
        }

        .btn-mini {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--bg);
            color: color-mix(in srgb, var(--text) 90%, var(--muted));
            cursor: pointer;
            font-weight: 700;
        }

        .btn-mini--ok {
            background: color-mix(in srgb, #10b981 22%, var(--bg));
            border-color: #10b981;
            color: #052e2b
        }

        .btn-mini:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin: 18px 0
        }

        .page {
            padding: 8px 12px;
            border-radius: 10px;
            background: color-mix(in srgb, var(--card) 70%, var(--bg));
            border: 1px solid var(--line);
            color: var(--text)
        }

        .page--active {
            font-weight: 800
        }

        /* Modal + toast */
        .modal-back {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 30
        }

        .modal {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            max-width: 520px;
            width: 92%;
            padding: 12px;
            box-shadow: 0 16px 40px rgba(0,0,0,.35)
        }

            .modal .row {
                justify-content: space-between
            }

            .modal textarea {
                width: 100%;
                min-height: 120px;
                background: var(--bg);
                color: var(--text);
                border: 1px solid var(--line);
                border-radius: 10px;
                padding: 10px
            }

            .modal .actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 10px
            }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: #0a1a2e;
            border: 1px solid #18324e;
            color: #dbe7f3;
            padding: 10px 12px;
            border-radius: 10px;
            display: none;
            z-index: 40
        }

            .toast.ok {
                border-color: #065f46;
                background: #052e2b;
                color: #d1fae5
            }

            .toast.warn {
                border-color: #92400e;
                background: #2f2612;
                color: #fff7ed
            }

        /* === DARK MODE CONTRAST FIXES (only overrides on dark) === */
        html:not([data-theme="light"]) .status--pendente,
        html:not([data-theme="light"]) .status--em_analise,
        html:not([data-theme="light"]) .status--resolvido {
            color: #ffffff; /* chips text white on dark */
        }

        html:not([data-theme="light"]) .btn-mini--ok {
            color: #eafff7; /* "Resolver" text readable on dark */
        }
    </style>
</head>
<body>

    {% include 'core/_header.html' %}

    <!-- hidden csrf (for AJAX) -->
    <form id="csrf-form" style="display:none">{% csrf_token %}</form>

    <!-- Filters -->
    <form method="get" class="filters">
        <div class="w-3"><input name="aluno" placeholder="Filtrar por aluno" value="{{ aluno }}" /></div>
        <div class="w-3"><input name="operador" placeholder="Filtrar por operador" value="{{ operador }}" /></div>
        <div class="w-3"><input name="curso" placeholder="Filtrar por curso" value="{{ curso }}" /></div>

        <div class="w-3">
            <select name="tipo" aria-label="Filtrar por tipo">
                <option value="">Todos os tipos</option>
                {% for k,v in tipo_choices %}
                <option value="{{ k }}" {% if tipo == k %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="w-3">
            <select name="assunto" aria-label="Filtrar por assunto">
                <option value="">Todos os assuntos</option>
                {% for k,v in assunto_choices %}
                <option value="{{ k }}" {% if assunto == k %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="w-3">
            <select name="status" aria-label="Filtrar por status">
                <option value="">Todos os status</option>
                {% for k,v in status_choices %}
                <option value="{{ k }}" {% if status == k %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="w-2"><input type="date" name="de" value="{{ de }}" placeholder="De" /></div>
        <div class="w-2"><input type="date" name="ate" value="{{ ate }}" placeholder="Até" /></div>

        <div class="w-4 right">
            <button class="btn-hero" type="submit">
                <span class="material-symbols-rounded">filter_list</span> Aplicar
            </button>
            <a class="btn-hero btn-hero--ghost" href="{% url 'feedback_list' %}">
                <span class="material-symbols-rounded">mop</span> Limpar
            </a>
        </div>
    </form>

    <!-- Cards grid -->
    <div class="grid">
        {% for f in items %}
        <article class="card {% if f.status == 'resolvido' %}card--dim{% endif %}" id="card-{{ f.id }}">
            <!-- header -->
            <div class="row" style="justify-content:space-between">
                <div class="row">
                    <span class="chip chip--id">
                        <span class="material-symbols-rounded">tag</span> #{{ f.id }}
                    </span>
                    <span class="chip">
                        <span class="material-symbols-rounded">calendar_month</span>
                        {{ f.created_at|date:"d/m/Y H:i" }}
                    </span>
                    <span class="chip chip--count" title="Anexos">
                        <span class="material-symbols-rounded">attach_file</span> {{ f.attachments.count }}
                    </span>
                </div>

                <span id="status-{{ f.id }}" class="status
            {% if f.status == 'resolvido' %} status--resolvido
            {% elif f.status == 'em_analise' %} status--em_analise
            {% else %} status--pendente {% endif %}">
                    <span class="material-symbols-rounded">
                        {% if f.status == 'resolvido' %}check_circle
                        {% elif f.status == 'em_analise' %}hourglass
                        {% else %}priority_high{% endif %}
                    </span>
                    {{ f.get_status_display }}
                </span>
            </div>

            <!-- headline -->
            <div class="row">
                <strong class="grow" style="font-size:16px">{{ f.student_name }}</strong>
                <span class="muted">
                    <span class="material-symbols-rounded" style="font-size:18px">person</span>
                    Operador: {{ f.operator_name|default:"—" }}
                </span>
            </div>

            <!-- tags -->
            <div class="row">
                <span class="tag t-{{ f.type }}"><i></i> {{ f.get_type_display }}</span>
                <span class="tag s-{{ f.subject }}"><i></i> {{ f.get_subject_display }}</span>
                <span class="muted">
                    <span class="material-symbols-rounded" style="font-size:18px">school</span>
                    Curso: {{ f.course_name|default:"—" }} · Turma: {{ f.class_name|default:"—" }}
                </span>
            </div>

            <div class="sep"></div>

            <!-- footer actions -->
            <div class="card__footer">
                {% if f.status != 'resolvido' %}
                <button class="btn-mini btn-mini--ok" data-resolve="{{ f.id }}">
                    <span class="material-symbols-rounded">task_alt</span> Resolver
                </button>
                {% endif %}

                <span class="grow"></span>

                <button class="btn-mini" data-comment="{{ f.id }}">
                    <span class="material-symbols-rounded">chat_add_on</span> Comentar
                </button>

                <a class="btn-mini" href="{% url 'feedback_detail' f.id %}">
                    <span class="material-symbols-rounded">visibility</span> Ver
                </a>
            </div>
        </article>
        {% empty %}
        <p class="muted">Sem resultados para os filtros informados.</p>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a class="page" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">‹ Anterior</a>
        {% endif %}
        <span class="page page--active">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a class="page" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Próxima ›</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Comment modal -->
    <div class="modal-back" id="modal-back">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
            <div class="row">
                <h3 id="m-title" style="margin:0">Adicionar comentário</h3>
                <button class="btn-mini" id="m-close">
                    <span class="material-symbols-rounded">close</span> Fechar
                </button>
            </div>
            <p class="muted" id="m-sub" style="margin:0 0 8px"></p>
            <textarea id="m-text" placeholder="Escreva o comentário..."></textarea>
            <div class="actions">
                <button class="btn btn--ghost" id="m-cancel">
                    <span class="material-symbols-rounded">cancel</span> Cancelar
                </button>
                <button class="btn" id="m-save">
                    <span class="material-symbols-rounded">save</span> Salvar comentário
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        (function () {
            const getCSRF = () => {
                const el = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]');
                return el ? el.value : '';
            };
            const toast = (msg, kind = 'ok') => {
                const t = document.getElementById('toast');
                t.className = 'toast ' + kind;
                t.textContent = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 2500);
            };

            // Resolve handler
            document.querySelectorAll('[data-resolve]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute('data-resolve');
                    btn.disabled = true;

                    const fd = new FormData();
                    fd.append('action', 'status');
                    fd.append('status', 'resolvido');

                    const resp = await fetch(`/feedbacks/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRF() },
                        body: fd,
                        credentials: 'same-origin'
                    });

                    if (resp.ok) {
                        const chip = document.getElementById(`status-${id}`);
                        if (chip) {
                            chip.innerHTML = '<span class="material-symbols-rounded">check_circle</span> Resolvido';
                            chip.classList.remove('status--pendente', 'status--em_analise');
                            chip.classList.add('status--resolvido');
                        }
                        document.getElementById(`card-${id}`)?.classList.add('card--dim');
                        btn.parentElement.removeChild(btn);
                        toast(`Status do #${id} atualizado.`, 'ok');
                    } else {
                        btn.disabled = false;
                        toast('Falha ao atualizar status.', 'warn');
                    }
                });
            });

            // Comment modal
            const modalBack = document.getElementById('modal-back');
            const mClose = document.getElementById('m-close');
            const mCancel = document.getElementById('m-cancel');
            const mSave = document.getElementById('m-save');
            const mText = document.getElementById('m-text');
            const mSub = document.getElementById('m-sub');
            let currentId = null;

            const openModal = (id) => {
                currentId = id; mText.value = '';
                mSub.textContent = `Feedback #${id}`;
                modalBack.style.display = 'flex';
                setTimeout(() => mText.focus(), 50);
            };
            const closeModal = () => { modalBack.style.display = 'none'; currentId = null; };

            document.querySelectorAll('[data-comment]')
                .forEach(btn => btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(btn.getAttribute('data-comment'));
                }));

            [mClose, mCancel].forEach(b => b.addEventListener('click', e => { e.preventDefault(); closeModal(); }));

            mSave.addEventListener('click', async (e) => {
                e.preventDefault();
                const text = mText.value.trim();
                if (!currentId || !text) { toast('Escreva um comentário.', 'warn'); return; }

                const fd = new FormData();
                fd.append('action', 'comment');
                fd.append('comment_text', text);

                const resp = await fetch(`/feedbacks/${currentId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRF() },
                    body: fd,
                    credentials: 'same-origin'
                });

                if (resp.ok) { toast(`Comentário adicionado ao #${currentId}.`, 'ok'); closeModal(); }
                else { toast('Falha ao adicionar comentário.', 'warn'); }
            });

            modalBack.addEventListener('click', (e) => { if (e.target === modalBack) closeModal(); });
        })();
    </script>
</body>
</html>
